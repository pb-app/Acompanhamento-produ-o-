<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Acompanhamento de Produção</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <style>
    :root{--primary:#0077cc;--muted:#e6f0ff;--card:#ffffff;--accent:#ff9900}
    *{box-sizing:border-box}
    body{font-family:Arial,Helvetica,sans-serif;margin:0;background:var(--muted);color:#222}
    header{background:var(--primary);color:#fff;padding:14px 12px;text-align:center}
    .container{max-width:980px;margin:18px auto;padding:16px;background:var(--card);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.08)}
    h1,h2{margin:0 0 12px}
    .nav{display:flex;gap:8px;justify-content:center;margin-bottom:14px}
    .nav a{color:var(--primary);text-decoration:none;font-weight:700;padding:6px 10px;border-radius:6px}
    .nav a.active{background:rgba(0,0,0,0.04)}
    form{display:grid;grid-template-columns:repeat(2,1fr);gap:10px}
    label{font-size:13px;font-weight:700;margin-bottom:4px;display:block}
    input[type="date"], input[type="text"], input[type="number"], select, textarea{width:100%;padding:8px;border:1px solid #cfd8e3;border-radius:6px}
    textarea{min-height:70px;resize:vertical}
    .full{grid-column:1/-1}
    button{background:var(--primary);color:#fff;border:none;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    button.secondary{background:#eee;color:#111}
    button.delete-btn{background:#dc3545;padding:4px 8px;font-size:12px;}
    /* Aumenta o espaço dos filtros do dashboard */
    .filtros{display:flex;flex-wrap:wrap;gap:8px;align-items:center;margin-bottom: 10px;} 
    .filtros input, .filtros select{padding:6px}
    table{width:100%;border-collapse:collapse;margin-top:12px}
    th,td{border:1px solid #e0e6ef;padding:8px;text-align:center;font-size:13px}
    th{background:var(--primary);color:#fff}
    .table-porcentagem{min-width: 80px;} 
    .charts{display:grid;gap:18px;margin-top:20px}
    @media(min-width:880px){form{grid-template-columns:repeat(3,1fr)}.charts{grid-template-columns:1fr 1fr}}
    /* Estilos para os vizualizadores (KPIs) */
    .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin:20px 0 0;}
    .kpi-card{background:var(--muted);padding:12px;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
    .kpi-card h3{font-size:14px;color:#555;margin:0 0 4px}
    .kpi-card p{font-size:28px;font-weight:bold;margin:0;color:var(--primary)} 
    .kpi-card.percent p{color:#00a000} 

    /* Estilo para a nova área do Operador */
    #analiseOperadorArea{
        border: 2px solid var(--accent);
        padding: 15px;
        border-radius: 10px;
        margin-top: 15px;
    }
    #analiseOperadorArea h3 {
        color: var(--accent);
        text-align: center;
        margin-bottom: 10px;
    }
    #analiseOperadorArea .kpi-card p {
        color: var(--accent); /* Destaca os números do operador */
        font-size: 26px; 
    }
  </style>
</head>
<body>
  <header><h1>Acompanhamento de Produção</h1></header>

  <div class="container">
    <div class="nav">
      <a href="#" id="linkLanc" class="active" onclick="mostrarPagina('lancamento')">Lançamento</a>
      <a href="#" id="linkHist" onclick="mostrarPagina('historico')">Histórico</a>
      <a href="#" id="linkDash" onclick="mostrarPagina('dashboard')">Dashboard</a>
    </div>

    <section id="lancamento">
      <h2>Lançamento de Produção</h2>
      <form id="formProducao">
        <div>
          <label>Data</label>
          <input type="date" id="data" required />
        </div>

        <div>
          <label>Setor</label>
          <select id="setor" required>
            <option value="">Selecione</option>
            <option>Conformação</option>
            <option>Esmaltação</option>
            <option>Embalagem</option>
            <option>Forno Vidrado</option>
            <option>Forno Chicote</option>
          </select>
        </div>

        <div>
          <label>Turno</label>
          <select id="turno" required>
            <option value="">Selecione</option>
            <option>Comercial</option> 
            <option>Turno 1 (6x2)</option>
            <option>Turno 2 (6x2)</option>
            <option>Turno 3 (6x2)</option>
            <option>Turno 4 (6x2)</option>
            <option>Turno 1 (5x2)</option>
            <option>Turno 2 (5x2)</option>
          </select>
        </div>
        
        <div>
          <label>Operador</label>
          <input type="text" id="operador" required />
        </div>

        <div>
          <label>Máquina</label>
          <select id="maquinaSelect" required>
            <option value="">Selecione o setor primeiro</option>
          </select>
        </div>

        <div>
          <label>Massa</label>
          <select id="massa" required>
            <option value="">Selecione</option>
            <option>Stone</option>
            <option>Faiança</option>
          </select>
        </div>

        <div>
          <label>Produção Prevista</label>
          <input type="number" id="prevista" min="0" required />
        </div>

        <div>
          <label>Produção Realizada</label>
          <input type="number" id="realizada" min="0" required />
        </div>

        <div>
          <label>Quebras</label>
          <input type="number" id="quebras" min="0" required />
        </div>

        <div class="full">
          <label>Observação</label>
          <textarea id="observacao"></textarea>
        </div>

        <div class="full" style="text-align:right;">
          <button type="button" class="secondary" onclick="limparFormulario()">Limpar</button>
          <button type="submit">Lançar</button>
        </div>
      </form>
    </section>

    <section id="historico" style="display:none">
      <h2>Histórico</h2>

      <div class="filtros">
        <input type="date" id="filtroDataInicio" placeholder="Data Início" />
        <input type="date" id="filtroDataFim" placeholder="Data Fim" />
        <select id="filtroSetor">
          <option value="">Todos os Setores</option>
          <option>Conformação</option>
          <option>Esmaltação</option>
          <option>Embalagem</option>
          <option>Forno Vidrado</option>
          <option>Forno Chicote</option>
        </select>
        <select id="filtroTurno">
          <option value="">Todos os Turnos</option>
          <option>Comercial</option> 
          <option>Turno 1 (6x2)</option>
          <option>Turno 2 (6x2)</option>
          <option>Turno 3 (6x2)</option>
          <option>Turno 4 (6x2)</option>
          <option>Turno 1 (5x2)</option>
          <option>Turno 2 (5x2)</option>
        </select>
        <input type="text" id="filtroMaquina" placeholder="Máquina..." />
        <button onclick="filtrarHistorico()">Filtrar</button>
        <button class="secondary" onclick="buscarTodos()">Mostrar todos</button>
        <button style="background:green;" onclick="exportarExcel()">Exportar Excel</button>
      </div>

      <table id="tabelaHistorico">
        <thead>
          <tr>
            <th>Data</th>
            <th>Setor</th>
            <th>Turno</th>
            <th>Operador</th>
            <th>Máquina</th>
            <th>Massa</th>
            <th>Prevista</th>
            <th>Realizada</th>
            <th>Quebras</th>
            <th>Obs</th>
            <th class="table-porcentagem">% Realizado/Previsto</th>
            <th class="table-porcentagem">% Quebras/Realizado</th>
            <th>Ação</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </section>

    <section id="dashboard" style="display:none">
      <h2>Dashboard</h2>

      <div class="filtros">
        <input type="date" id="dashFiltroDataInicio" placeholder="Data Início" />
        <input type="date" id="dashFiltroDataFim" placeholder="Data Fim" />
        
        <select id="dashFiltroSetor">
          <option value="">Todos os Setores</option>
          <option>Conformação</option>
          <option>Esmaltação</option>
          <option>Embalagem</option>
          <option>Forno Vidrado</option>
          <option>Forno Chicote</option>
        </select>

        <select id="dashFiltroTurno">
          <option value="">Todos os Turnos</option>
          <option>Comercial</option> 
          <option>Turno 1 (6x2)</option>
          <option>Turno 2 (6x2)</option>
          <option>Turno 3 (6x2)</option>
          <option>Turno 4 (6x2)</option>
          <option>Turno 1 (5x2)</option>
          <option>Turno 2 (5x2)</option>
        </select>
        <input type="text" id="dashFiltroMaquina" placeholder="Máquina..." />
        <input type="text" id="dashFiltroOperador" placeholder="Operador..." /> 
        <button onclick="atualizarDashboard()">Aplicar Filtro</button>
      </div>
      
      <h3>Resumo Geral da Produção (Filtros Aplicados)</h3>
      <div class="kpis" id="kpisResumo">
        <div class="kpi-card"><h3>Total Previsto</h3><p id="kpiPrevisto">0</p></div>
        <div class="kpi-card"><h3>Total Realizado</h3><p id="kpiRealizado">0</p></div>
        <div class="kpi-card"><h3>Total Quebras</h3><p id="kpiQuebras">0</p></div>
        <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiPercRealPrev">N/A</p></div>
        <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiPercQuebraTotal">N/A</p></div>
      </div>
      
      <div id="analiseOperadorArea">
        <h3>Análise do Operador: <span id="operadorSelecionado">Nenhum</span></h3>
        <div class="kpis" id="kpisOperador">
            <div class="kpi-card"><h3>Previsto Operador</h3><p id="kpiOperadorPrevisto">0</p></div>
            <div class="kpi-card"><h3>Realizado Operador</h3><p id="kpiOperadorRealizado">0</p></div>
            <div class="kpi-card"><h3>Quebras Operador</h3><p id="kpiOperadorQuebras">0</p></div>
            <div class="kpi-card percent"><h3>% Realizado/Previsto</h3><p id="kpiOperadorPercRealPrev">N/A</p></div>
            <div class="kpi-card percent"><h3>% Quebras/Total</h3><p id="kpiOperadorPercQuebraTotal">N/A</p></div>
        </div>
      </div>


      <div class="charts">
        <canvas id="graficoProducao"></canvas>
        <canvas id="graficoQuebras"></canvas>
        <canvas id="graficoTurnos"></canvas>
      </div>
    </section>
  </div>
  
  <script type="module">
    // Importa as funções de inicialização do Firebase App
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
    // Importa as funções necessárias para o Firestore
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        getDocs, 
        query, 
        where, 
        orderBy, 
        deleteDoc, 
        doc 
    } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

    // Sua configuração do aplicativo web Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyB2z4mFj5qVtb59uocKK8JXhMTfi8MGSTo",
      authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
      projectId: "acompanhamento-de-produc-b68b0",
      storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
      messagingSenderId: "891709449679",
      appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
    };

    // Inicializa o Firebase App
    const app = initializeApp(firebaseConfig);
    
    // Inicializa o Firestore
    const db = getFirestore(app);
    
    // =========================================================
    // CORREÇÃO: Torna as referências e funções do Firestore globais (window.funcao)
    // Isso resolve o ReferenceError: addDoc is not defined
    // =========================================================
    window.db = db;
    window.producoesCol = collection(db, "producoes"); 
    window.addDoc = addDoc;        
    window.getDocs = getDocs;      
    window.query = query;          
    window.where = where;          
    window.orderBy = orderBy;      
    window.deleteDoc = deleteDoc;  
    window.doc = doc;              
    
    console.log("Firebase e Firestore inicializados!");
  </script>

<script>
// NOTA: As variáveis globais abaixo agora SÃO AS PRÓPRIAS FUNÇÕES DO FIREBASE (ex: addDoc, getDocs)
// A função DOMContentLoaded apenas pega as referências de db e da coleção.
let db, producoesCol;

document.addEventListener("DOMContentLoaded", ()=>{
  db = window.db; 
  producoesCol = window.producoesCol; 
  
  // LOG DE VERIFICAÇÃO (OPCIONAL)
  console.log("Variáveis DB carregadas:", !!db, !!producoesCol);

  const today = new Date().toISOString().split('T')[0];
  document.getElementById("data").value = today;
  // Define a data de início do filtro do dashboard para 7 dias atrás e a de fim para hoje
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  document.getElementById("dashFiltroDataInicio").value = sevenDaysAgo;
  document.getElementById("dashFiltroDataFim").value = today;
});

const maquinasPorSetor = {
  "Conformação":["Secador 2","Secador 3","Secador 4","Secador 10","Máquina de Xícara 1","Máquina de Xícara 2","Máquina de Prato","Prensa"],
  "Esmaltação":["Disco 1","Disco 2","Disco 3","Disco 4","Robô 1","Robô 2","Spray","Imersão"],
  "Embalagem":["Linha 1","Linha 2","Linha 3","Linha 4","Linha 5"],
  "Forno Vidrado":["Forno 1","Forno 2"],
  "Forno Chicote":["Forno 3"]
};

document.getElementById("setor").addEventListener("change", e=>{
  const setor=e.target.value;
  const maqSelect=document.getElementById("maquinaSelect");
  maqSelect.innerHTML="";
  const optDefault=document.createElement("option");
  optDefault.textContent="(Digite manualmente)";
  optDefault.value="";
  maqSelect.appendChild(optDefault);

  if(maquinasPorSetor[setor]){
    maquinasPorSetor[setor].forEach(m=>{
      const opt=document.createElement("option");
      opt.textContent=m; opt.value=m;
      maqSelect.appendChild(opt);
    });
  }
});

function mostrarPagina(pg){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(pg).style.display="block";
  document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
  document.querySelector(`#link${pg.charAt(0).toUpperCase()+pg.slice(1)}`).classList.add("active");
  if(pg==="historico") atualizarTabela();
  if(pg==="dashboard") atualizarDashboard();
}

/**
 * Lança o registro no Firestore.
 * @param {Event} e 
 */
document.getElementById("formProducao").addEventListener("submit", async (e)=>{
  e.preventDefault();
  
  // O addDoc agora é uma função global (window.addDoc)
  if (!producoesCol || !window.addDoc) { 
      alert("Aguarde, o Firebase ainda não foi inicializado corretamente.");
      return;
  }
  
  const data = {
    data:document.getElementById("data").value,
    setor:document.getElementById("setor").value,
    turno:document.getElementById("turno").value,
    operador:document.getElementById("operador").value,
    maquina:document.getElementById("maquinaSelect").value || document.getElementById("maquinaSelect").value, // Se o select for vazio, pega o valor que o usuário digitou
    massa:document.getElementById("massa").value,
    prevista:parseFloat(document.getElementById("prevista").value),
    realizada:parseFloat(document.getElementById("realizada").value),
    quebras:parseFloat(document.getElementById("quebras").value),
    observacao:document.getElementById("observacao").value,
    timestamp: new Date().toISOString() // Adiciona um timestamp para ordenação
  };

  try {
      // SUBSTITUIÇÃO: Salva no Firestore
      await window.addDoc(producoesCol, data);
      alert("Lançamento salvo com sucesso no Firebase!");
      limparFormulario();
  } catch (error) {
      console.error("Erro ao adicionar documento: ", error);
      // Se você estava vendo o erro 'addDoc is not defined', agora você verá o erro de permissão (403) ou o sucesso.
      alert("Erro ao salvar o lançamento. Verifique o console."); 
  }
});

function limparFormulario(){document.getElementById("formProducao").reset();}

/**
 * Deleta um registro no Firestore.
 * @param {string} docId O ID do documento a ser deletado.
 */
async function deletarRegistro(docId) {
    if (confirm("Tem certeza que deseja deletar este registro de produção?")) {
        // As funções do Firestore agora estão no escopo global (window)
        if (!docId || !producoesCol || !window.deleteDoc || !window.doc) {
            alert("Erro: ID do documento ou conexão Firebase inválida.");
            return;
        }
        
        try {
            // SUBSTITUIÇÃO: Deleta no Firestore
            await window.deleteDoc(window.doc(db, "producoes", docId));
            alert("Registro deletado com sucesso!");
            atualizarTabela(); 
        } catch (error) {
            console.error("Erro ao deletar documento: ", error);
            alert("Erro ao deletar o registro. Verifique o console.");
        }
    }
}

/**
 * Busca e atualiza a tabela com dados do Firestore (opcionalmente filtrados).
 * @param {object|null} filtro Objeto de filtro ou null.
 */
async function atualizarTabela(filtro=null){
  const tbody=document.querySelector("#tabelaHistorico tbody");
  tbody.innerHTML="<tr><td colspan='13'>Carregando dados...</td></tr>";
  
  if (!producoesCol || !window.getDocs || !window.query) {
      tbody.innerHTML="<tr><td colspan='13'>Erro: O Firebase não está conectado.</td></tr>";
      return;
  }

  // 1. Cria a query inicial
  let q = window.query(producoesCol, window.orderBy("data", "desc"), window.orderBy("timestamp", "desc"));
  const conditions = [];
  
  // 2. Adiciona filtros se existirem
  if(filtro){
    if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
    if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    if(filtro.setor) conditions.push(window.where("setor", "==", filtro.setor));
    if(filtro.turno) conditions.push(window.where("turno", "==", filtro.turno));
  }

  // Se houver condições, aplicamos a query
  if (conditions.length > 0) {
      q = window.query(producoesCol, ...conditions, window.orderBy("data", "desc"), window.orderBy("timestamp", "desc"));
  }

  try {
      // 3. Executa a busca no Firestore
      const querySnapshot = await window.getDocs(q);
      const regs = [];
      querySnapshot.forEach(doc => {
          // Coleta o ID do documento para exclusão e os dados
          regs.push({ id: doc.id, ...doc.data() });
      });

      let filtrados = regs;
      
      // Filtros manuais (para Máquina, se necessário)
      if(filtro && filtro.maquina){
          const maquinaFiltro = filtro.maquina.toLowerCase();
          filtrados = filtrados.filter(r => r.maquina && r.maquina.toLowerCase().includes(maquinaFiltro));
      }

      // 4. Renderiza a tabela
      tbody.innerHTML="";
      if (filtrados.length === 0) {
           tbody.innerHTML="<tr><td colspan='13'>Nenhum registro encontrado com este filtro.</td></tr>";
           return;
      }
      
      filtrados.forEach(r=>{
        const prev = parseFloat(r.prevista) || 0;
        const real = parseFloat(r.realizada) || 0;
        const queb = parseFloat(r.quebras) || 0;
        
        const percRealizadoPrevisto = prev > 0 ? ((real / prev) * 100).toFixed(2) + '%' : (real > 0 ? 'INF' : 'N/A');

        const totalProd = real + queb;
        const percQuebrasRealizado = totalProd > 0 ? ((queb / totalProd) * 100).toFixed(2) + '%' : 'N/A';
        
        const tr=document.createElement("tr");
        // O doc.id (r.id) é passado para a função deletarRegistro
        tr.innerHTML=`<td>${r.data}</td><td>${r.setor}</td><td>${r.turno}</td><td>${r.operador}</td>
          <td>${r.maquina}</td><td>${r.massa}</td>
          <td>${real}</td><td>${prev}</td><td>${queb}</td><td>${r.observacao}</td>
          <td>$
