<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>


<script>
// ===============================================
// 1. CONFIGURAÇÃO E CONEXÃO COM FIREBASE (COM SEUS DADOS)
// ===============================================

// Seus dados de configuração reais
const firebaseConfig = {
    apiKey: "AIzaSyB2z4mFj5qVtb59uocKK8JXhMTfi8MGSTo",
    authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
    projectId: "acompanhamento-de-produc-b68b0",
    storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
    messagingSenderId: "891709449679",
    appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
};

// Inicializa o Firebase e o Firestore
// ESTA É A LINHA CRÍTICA. SE DER ERRO, VERIFIQUE O CONSOLE!
firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
const COLECAO_PRODUCAO = "registros_producao";
// ===============================================

document.addEventListener("DOMContentLoaded", ()=>{
  // Mantenha seu código DOMContentLoaded
  const today = new Date().toISOString().split('T')[0];
  document.getElementById("data").value = today;
  // Define a data de início do filtro do dashboard para 7 dias atrás e a de fim para hoje
  const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
  document.getElementById("dashFiltroDataInicio").value = sevenDaysAgo;
  document.getElementById("dashFiltroDataFim").value = today;
});

const maquinasPorSetor = {
  "Conformação":["Secador 2","Secador 3","Secador 4","Secador 10","Máquina de Xícara 1","Máquina de Xícara 2","Máquina de Prato","Prensa"],
  "Esmaltação":["Disco 1","Disco 2","Disco 3","Disco 4","Robô 1","Robô 2","Spray","Imersão"],
  "Embalagem":["Linha 1","Linha 2","Linha 3","Linha 4","Linha 5"]
};

document.getElementById("setor").addEventListener("change", e=>{
  const setor=e.target.value;
  const maqSelect=document.getElementById("maquinaSelect");
  maqSelect.innerHTML="";
  if(maquinasPorSetor[setor]){
    maquinasPorSetor[setor].forEach(m=>{
      const opt=document.createElement("option");
      opt.textContent=m; opt.value=m;
      maqSelect.appendChild(opt);
    });
  }else{
    const opt=document.createElement("option");
    opt.textContent="(Digite manualmente)";
    maqSelect.appendChild(opt);
  }
});

// Tornamos 'mostrarPagina' assíncrona para aguardar as funções do Firebase
async function mostrarPagina(pg){
  document.querySelectorAll("section").forEach(s=>s.style.display="none");
  document.getElementById(pg).style.display="block";
  document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
  document.querySelector(`#link${pg.charAt(0).toUpperCase()+pg.slice(1)}`).classList.add("active");
  if(pg==="historico") await atualizarTabela();
  if(pg==="dashboard") await atualizarDashboard();
}

// ===============================================
// LÓGICA DE SALVAMENTO (AGORA NO FIREBASE)
// ===============================================
document.getElementById("formProducao").addEventListener("submit", e=>{
  e.preventDefault();
  const data={
    data:document.getElementById("data").value,
    setor:document.getElementById("setor").value,
    turno:document.getElementById("turno").value,
    operador:document.getElementById("operador").value,
    maquina:document.getElementById("maquinaSelect").value,
    massa:document.getElementById("massa").value,
    prevista:parseFloat(document.getElementById("prevista").value) || 0,
    realizada:parseFloat(document.getElementById("realizada").value) || 0,
    quebras:parseFloat(document.getElementById("quebras").value) || 0,
    observacao:document.getElementById("observacao").value
  };
  
  // SALVANDO NO FIREBASE
  db.collection(COLECAO_PRODUCAO).add(data)
    .then(() => {
      alert("Lançamento salvo na nuvem!");
      limparFormulario();
      // Atualiza o histórico ou dashboard se estiverem abertos
      if(document.getElementById('historico').style.display !== 'none') atualizarTabela();
      if(document.getElementById('dashboard').style.display !== 'none') atualizarDashboard();
    })
    .catch((error) => {
      console.error("Erro ao adicionar documento: ", error);
      alert("Erro ao salvar o lançamento. Verifique o console do navegador e as regras do Firebase.");
    });
});
// ===============================================

function limparFormulario(){document.getElementById("formProducao").reset();}

// ===============================================
// LÓGICA DE DELETAR (AGORA NO FIREBASE)
// ===============================================
function deletarRegistro(documentId) {
    if (confirm("Tem certeza que deseja deletar este registro de produção?")) {
        // DELETANDO NO FIREBASE PELO ID DO DOCUMENTO
        db.collection(COLECAO_PRODUCAO).doc(documentId).delete()
            .then(() => {
                alert("Registro deletado com sucesso!");
                atualizarTabela(); 
            })
            .catch(error => {
                console.error("Erro ao deletar: ", error);
                alert("Erro ao deletar o registro.");
            });
    }
}
// ===============================================

// ===============================================
// LÓGICA DE CARREGAR DADOS (AGORA DO FIREBASE)
// ===============================================
async function atualizarTabela(filtro=null){
  const tbody=document.querySelector("#tabelaHistorico tbody");
  tbody.innerHTML="<tr><td colspan='13'>Carregando dados da nuvem...</td></tr>";
  
  try{
    // BUSCA OS DADOS NO FIREBASE E ORDENA POR DATA
    const snapshot = await db.collection(COLECAO_PRODUCAO).orderBy('data', 'desc').get();
    
    const regsFormatados = [];
    snapshot.forEach(doc => {
        // Pega os dados e adiciona o ID do documento para ser usado na função Deletar
        regsFormatados.push({ ...doc.data(), id: doc.id }); 
    });
    
    let filtrados = regsFormatados;

    if(filtro){
      const dataInicio = filtro.dataInicio;
      const dataFim = filtro.dataFim;
      const maquina = (filtro.maquina || '').toLowerCase();

      filtrados=regsFormatados.filter(r=>
        (!dataInicio || r.data >= dataInicio) &&
        (!dataFim || r.data <= dataFim) &&
        (!filtro.setor||r.setor===filtro.setor)&&
        (!filtro.turno||r.turno===filtro.turno)&&
        (!maquina||(r.maquina && r.maquina.toLowerCase().includes(maquina)))
      );
    }

    tbody.innerHTML = "";
    if (filtrados.length === 0) {
        tbody.innerHTML = "<tr><td colspan='13'>Nenhum registro encontrado.</td></tr>";
    }

    // O resto da lógica de renderização
    filtrados.forEach(r=>{
      const prev = parseFloat(r.prevista) || 0;
      const real = parseFloat(r.realizada) || 0;
      const queb = parseFloat(r.quebras) || 0;
      
      const percRealizadoPrevisto = prev > 0 ? ((real / prev) * 100).toFixed(2) + '%' : (real > 0 ? 'INF' : 'N/A');
      const totalProd = real + queb;
      const percQuebrasRealizado = totalProd > 0 ? ((queb / totalProd) * 100).toFixed(2) + '%' : 'N/A';
      
      const tr=document.createElement("tr");
      // ATENÇÃO: O botão deletar agora usa o r.id (ID do Firebase)
      tr.innerHTML=`<td>${r.data}</td><td>${r.setor}</td><td>${r.turno}</td><td>${r.operador}</td>
        <td>${r.maquina}</td><td>${r.massa}</td>
        <td>${r.prevista}</td><td>${r.realizada}</td><td>${r.quebras}</td><td>${r.observacao}</td>
        <td>${percRealizadoPrevisto}</td>
        <td>${percQuebrasRealizado}</td>
        <td><button class="delete-btn" onclick="deletarRegistro('${r.id}')">Deletar</button></td>`; 
      tbody.appendChild(tr);
    });

  } catch(error) {
    console.error("Erro ao buscar dados do Firebase:", error);
    tbody.innerHTML = "<tr><td colspan='13'>Falha ao carregar dados. Verifique a conexão e as regras do Firebase.</td></tr>";
  }
}
// ===============================================

function filtrarHistorico(){
  const filtro={
    dataInicio:document.getElementById("filtroDataInicio").value,
    dataFim:document.getElementById("filtroDataFim").value,
    setor:document.getElementById("filtroSetor").value,
    turno:document.getElementById("filtroTurno").value,
    maquina:document.getElementById("filtroMaquina").value
  };
  atualizarTabela(filtro);
}

function buscarTodos(){atualizarTabela();}

function exportarExcel(){
  const rows=[...document.querySelectorAll("#tabelaHistorico tbody tr")];
  if(rows.length===0){alert("Nenhum dado para exportar.");return;}
  
  const headers = [...document.querySelectorAll("#tabelaHistorico thead th")].map(th => th.textContent);
  headers.pop(); 
  
  const data = [];
  rows.forEach(r => {
      const c = r.querySelectorAll("td");
      const rowData = {};
      
      for (let i = 0; i < headers.length; i++) {
          rowData[headers[i]] = c[i].textContent;
      }
      data.push(rowData);
  });
  
  const ws=XLSX.utils.json_to_sheet(data);
  const wb=XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb,ws,"Histórico");
  const nome=`Historico_Filtrado_${new Date().toISOString().split('T')[0]}.xlsx`;
  XLSX.writeFile(wb,nome);
}

/* ====== DASHBOARD ====== */
let grafico1, grafico2, grafico3;

// Função de filtragem usada pelo Dashboard (Mantida)
function filtrarDadosDashboard(dados, filtro) {
    return dados.filter(d => {
        const dentroPeriodo = 
            (!filtro.dataInicio || d.data >= filtro.dataInicio) &&
            (!filtro.dataFim || d.data <= filtro.dataFim);
        
        const setorCorreto = 
            (!filtro.setor || d.setor === filtro.setor); 
            
        const turnoCorreto = 
            (!filtro.turno || d.turno === filtro.turno);
            
        const maquinaCorreta = 
            (!filtro.maquina || (d.maquina && d.maquina.toLowerCase().includes(filtro.maquina.toLowerCase())));
            
        const operadorCorreto = 
            (!filtro.operador || (d.operador && d.operador.toLowerCase().includes(filtro.operador.toLowerCase())));

        return dentroPeriodo && setorCorreto && turnoCorreto && maquinaCorreta && operadorCorreto;
    });
}

// Função para calcular e atualizar KPIs em uma área específica (Mantida)
function calcularKPIsEstatistica(dados, prefixo) {
    let totalPrevisto = 0;
    let totalRealizado = 0;
    let totalQuebras = 0;

    dados.forEach(d => {
        totalPrevisto += parseFloat(d.prevista) || 0;
        totalRealizado += parseFloat(d.realizada) || 0;
        totalQuebras += parseFloat(d.quebras) || 0;
    });

    const totalProducao = totalRealizado + totalQuebras;
    
    const percRealPrev = totalPrevisto > 0 
        ? ((totalRealizado / totalPrevisto) * 100).toFixed(2) + '%' 
        : (totalRealizado > 0 ? 'INF' : 'N/A');

    const percQuebraTotal = totalProducao > 0 
        ? ((totalQuebras / totalProducao) * 100).toFixed(2) + '%' 
        : 'N/A';

    document.getElementById(`${prefixo}Previsto`).textContent = totalPrevisto.toLocaleString();
    document.getElementById(`${prefixo}Realizado`).textContent = totalRealizado.toLocaleString();
    document.getElementById(`${prefixo}Quebras`).textContent = totalQuebras.toLocaleString();
    document.getElementById(`${prefixo}PercRealPrev`).textContent = percRealPrev;
    document.getElementById(`${prefixo}PercQuebraTotal`).textContent = percQuebraTotal;
    
    return dados; 
}


// ===============================================
// LÓGICA DO DASHBOARD (AGORA BUSCA NO FIREBASE)
// ===============================================
async function atualizarDashboard(){
  
  // BUSCA OS DADOS NO FIREBASE
  const snapshot = await db.collection(COLECAO_PRODUCAO).get();
  const dadosGerais = [];
  snapshot.forEach(doc => {
      dadosGerais.push({ ...doc.data() }); 
  });
  // FIM DA BUSCA FIREBASE

  // 1. Coleta os filtros
  const filtro = {
    dataInicio: document.getElementById("dashFiltroDataInicio").value,
    dataFim: document.getElementById("dashFiltroDataFim").value,
    setor: document.getElementById("dashFiltroSetor").value, 
    turno: document.getElementById("dashFiltroTurno").value,
    maquina: document.getElementById("dashFiltroMaquina").value,
    operador: document.getElementById("dashFiltroOperador").value 
  };
  
  // 2. Filtra os dados
  const dadosFiltrados = filtrarDadosDashboard(dadosGerais, filtro);

  // 3. ANÁLISE GERAL (KPIs)
  calcularKPIsEstatistica(dadosFiltrados, 'kpi');
  
  // 4. ANÁLISE DO OPERADOR
  const operadorFiltroTexto = filtro.operador;
  document.getElementById("operadorSelecionado").textContent = operadorFiltroTexto || 'Nenhum';
  
  if (operadorFiltroTexto) {
    calcularKPIsEstatistica(dadosFiltrados, 'kpiOperador');
  } else {
    // Limpa os KPIs do operador se nenhum filtro for aplicado
    calcularKPIsEstatistica([], 'kpiOperador');
  }

  // 5. ATUALIZAÇÃO DOS GRÁFICOS (mantida)
  
  // Agrupar dados por Setor e Turno para os gráficos
  const resumoPorSetor = dadosFiltrados.reduce((acc, curr) => {
    acc[curr.setor] = acc[curr.setor] || { realizado: 0, quebras: 0 };
    acc[curr.setor].realizado += parseFloat(curr.realizada) || 0;
    acc[curr.setor].quebras += parseFloat(curr.quebras) || 0;
    return acc;
  }, {});

  const resumoPorTurno = dadosFiltrados.reduce((acc, curr) => {
    acc[curr.turno] = acc[curr.turno] || { realizado: 0, previsto: 0 };
    acc[curr.turno].realizado += parseFloat(curr.realizada) || 0;
    acc[curr.turno].previsto += parseFloat(curr.prevista) || 0;
    return acc;
  }, {});

  // Gráfico 1: Produção por Setor
  if(grafico1) grafico1.destroy();
  grafico1 = new Chart(document.getElementById('graficoProducao'), {
    type: 'bar',
    data: {
      labels: Object.keys(resumoPorSetor),
      datasets: [{
        label: 'Realizado',
        data: Object.values(resumoPorSetor).map(r => r.realizado),
        backgroundColor: '#0077cc',
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', },
        title: { display: true, text: 'Produção Realizada por Setor' }
      },
      scales: { y: { beginAtZero: true } }
    }
  });

  // Gráfico 2: Quebras por Setor
  if(grafico2) grafico2.destroy();
  grafico2 = new Chart(document.getElementById('graficoQuebras'), {
    type: 'doughnut',
    data: {
      labels: Object.keys(resumoPorSetor),
      datasets: [{
        label: 'Quebras',
        data: Object.values(resumoPorSetor).map(r => r.quebras),
        backgroundColor: ['#dc3545', '#ffc107', '#28a745', '#17a2b8', '#6c757d'],
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'right' },
        title: { display: true, text: 'Distribuição de Quebras por Setor' }
      }
    }
  });

  // Gráfico 3: Realizado/Previsto por Turno (em porcentagem)
  const labelsTurnos = Object.keys(resumoPorTurno);
  const dataTurnos = Object.values(resumoPorTurno).map(r => 
      r.previsto > 0 ? (r.realizado / r.previsto) * 100 : 0
  );

  if(grafico3) grafico3.destroy();
  grafico3 = new Chart(document.getElementById('graficoTurnos'), {
    type: 'bar',
    data: {
      labels: labelsTurnos,
      datasets: [{
        label: '% Realizado / Previsto',
        data: dataTurnos,
        backgroundColor: '#ff9900',
      }]
    },
    options: {
      responsive: true,
      plugins: {
        legend: { position: 'top', },
        title: { display: true, text: '% Realizado / Previsto por Turno' },
        tooltip: {
          callbacks: {
            label: function(context) {
              let label = context.dataset.label || '';
              if (label) { label += ': '; }
              if (context.parsed.y !== null) {
                label += context.parsed.y.toFixed(2) + '%';
              }
              return label;
            }
          }
        }
      },
      scales: {
        y: {
          beginAtZero: true,
          max: 150, // Define o limite superior em 150%
          ticks: { callback: function(value) { return value + '%'; } }
        }
      }
    }
  });
}
</script>
