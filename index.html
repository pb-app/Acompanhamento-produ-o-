<script>
// Variáveis globais
let db, producoesCol, operadoresCol;
const ITENS_POR_PAGINA = 30;
let ultimoDocumentoVisivel = null;
let primeiroDocumentoStack = [null];
let paginaAtual = 1;
let filtroAtual = null;

document.addEventListener("DOMContentLoaded", ()=>{
    db = window.db; 
    producoesCol = window.producoesCol; 
    operadoresCol = window.operadoresCol;
    
    const today = new Date().toISOString().split('T')[0];
    document.getElementById("data").value = today;
    document.getElementById("dataCadastroOp").value = today;
    document.getElementById("filtroDataInicio").value = today;
    document.getElementById("filtroDataFim").value = today;
    document.getElementById("dashFiltroDataInicio").value = today;
    document.getElementById("dashFiltroDataFim").value = today;

    // --- LINHA CORRIGIDA AQUI ---
    document.getElementById("setor").addEventListener("change", carregarOperadores);
    // --- FIM DA LINHA CORRIGIDA ---

    document.getElementById("formOperador").addEventListener("submit", cadastrarOperador);
    // LISTENERS PARA OS FORMULÁRIOS DE EDIÇÃO
    document.getElementById("formEdicaoHistorico").addEventListener("submit", salvarEdicaoHistorico);
    document.getElementById("formEdicaoOperador").addEventListener("submit", salvarEdicaoOperador);


    document.getElementById('filtroSetor').addEventListener('change', () => {
        atualizarDatalistMaquina('filtroSetor', 'listaMaquinasFiltro');
    });
    document.getElementById('dashFiltroSetor').addEventListener('change', () => {
        atualizarDatalistMaquina('dashFiltroSetor', 'listaMaquinasDash');
    });
    
    // Listeners para o modal de edição de histórico
    document.getElementById("edit-setor").addEventListener("change", () => carregarOperadores('edit-setor', 'edit-operadorSelect'));

});

const maquinasPorSetor = {
    "Conformação":["Secador 2","Secador 3","Secador 4","Secador 10","Máquina de Xícara 1","Máquina de Xícara 2","Máquina de Prato","Prensa"],
    "Esmaltação":["Disco 1","Disco 2","Disco 3","Disco 4","Robô 1","Robô 2","Spray","Imersão"],
    "Embalagem":["Linha 1","Linha 2","Linha 3","Linha 4","Linha 5"],
    "Forno Vidrado":["Forno 1","Forno 2"],
    "Forno Chicote":["Forno 3"]
};

document.getElementById("setor").addEventListener("change", e=>{
    const setor = e.target.value;
    const maqSelect = document.getElementById("maquinaSelect");
    maqSelect.innerHTML='<option value="">(Selecione ou Digite)</option>';
    if(maquinasPorSetor[setor]){
        maquinasPorSetor[setor].forEach(m=>{
            const opt=document.createElement("option");
            opt.textContent=m; opt.value=m;
            maqSelect.appendChild(opt);
        });
    }
});

function atualizarDatalistMaquina(idSetor, idDatalist) {
    const setor = document.getElementById(idSetor).value;
    const datalist = document.getElementById(idDatalist);
    datalist.innerHTML = ''; 

    if (maquinasPorSetor[setor]) {
        maquinasPorSetor[setor].forEach(m => {
            const option = document.createElement('option');
            option.value = m;
            datalist.appendChild(option);
        });
    }
}

function mostrarPagina(pg){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(pg).style.display="block";
    document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
    
    const linkId = `#link${pg.charAt(0).toUpperCase()}${pg.slice(1,4)}`;
    document.querySelector(linkId).classList.add("active");
    
    if(pg==="historico") filtrarHistorico(); 
    if(pg==="dashboard") atualizarDashboard();
    if(pg==="operadores") atualizarTabelaOperadores();
}

function toggleDetalhes(index) {
    const detalhesRow = document.getElementById(`detalhes-${index}`);
    const btn = event.target;
    if (detalhesRow.style.display === "table-row") {
        detalhesRow.style.display = "none";
        btn.textContent = "+";
    } else {
        detalhesRow.style.display = "table-row";
        btn.textContent = "-";
    }
}

async function cadastrarOperador(e) {
    e.preventDefault();
    if (!operadoresCol || !window.addDoc) { 
        alert("Aguarde, o Firebase ainda não foi inicializado corretamente.");
        return;
    }
    const data = {
        dataCadastro: document.getElementById("dataCadastroOp").value,
        nome: document.getElementById("nomeOperador").value,
        setor: document.getElementById("setorOperador").value,
        turno: document.getElementById("turnoOperador").value
    };
    try {
        await window.addDoc(operadoresCol, data);
        alert("Operador cadastrado com sucesso!");
        document.getElementById("formOperador").reset();
        document.getElementById("dataCadastroOp").value = new Date().toISOString().split('T')[0];
        atualizarTabelaOperadores();
    } catch (error) {
        console.error("Erro ao cadastrar operador:", error);
        alert("Erro ao cadastrar operador. Verifique o console.");
    }
}

// ----- FUNÇÕES DO MODAL (POP-UP) -----
function fecharModal() {
    document.getElementById('historicoModal').style.display = 'none';
    document.getElementById('operadorModal').style.display = 'none';
}

// --- LÓGICA DE EDIÇÃO DO OPERADOR ---
async function abrirOperadorModal(docId) {
    try {
        const docRef = window.doc(db, "operadores", docId);
        const docSnap = await window.getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('edit-id-operador').value = docId;
            document.getElementById('edit-dataCadastroOp').value = data.dataCadastro;
            document.getElementById('edit-nomeOperador').value = data.nome;
            document.getElementById('edit-setorOperador').value = data.setor;
            document.getElementById('edit-turnoOperador').value = data.turno;
            document.getElementById('operadorModal').style.display = 'block';
        } else {
            alert("Erro: Operador não encontrado!");
        }
    } catch (error) {
        console.error("Erro ao carregar operador para edição:", error);
    }
}

async function salvarEdicaoOperador(e) {
    e.preventDefault();
    const docId = document.getElementById('edit-id-operador').value;
    const data = {
        dataCadastro: document.getElementById("edit-dataCadastroOp").value,
        nome: document.getElementById("edit-nomeOperador").value,
        setor: document.getElementById("edit-setorOperador").value,
        turno: document.getElementById("edit-turnoOperador").value
    };

    try {
        const docRef = window.doc(db, "operadores", docId);
        await window.updateDoc(docRef, data);
        alert("Operador atualizado com sucesso!");
        fecharModal();
        atualizarTabelaOperadores();
    } catch (error) {
        console.error("Erro ao salvar operador:", error);
        alert("Erro ao salvar. Verifique o console.");
    }
}

async function atualizarTabelaOperadores() {
    const tbody = document.querySelector("#tabelaOperadores tbody");
    const busca = document.getElementById('buscaOperador').value.toLowerCase();
    tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

    if (!operadoresCol || !window.getDocs) return;

    try {
        const snapshot = await window.getDocs(query(operadoresCol, orderBy("nome")));
        
        let operadores = [];
        snapshot.forEach(doc => operadores.push({ id: doc.id, ...doc.data() }));

        if (busca) {
            operadores = operadores.filter(op => op.nome.toLowerCase().includes(busca));
        }

        if (operadores.length === 0) {
            tbody.innerHTML = "<tr><td colspan='5'>Nenhum operador encontrado.</td></tr>";
            return;
        }

        tbody.innerHTML = "";
        operadores.forEach(op => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td>${op.dataCadastro}</td>
                <td>${op.nome}</td>
                <td>${op.setor}</td>
                <td>${op.turno}</td>
                <td>
                    <button class="secondary" style="margin-right:5px" onclick="abrirOperadorModal('${op.id}')">Editar</button>
                    <button class="delete-btn" onclick="deletarOperador('${op.id}')">Deletar</button>
                </td>`;
            tbody.appendChild(tr);
        });
    } catch (error) {
        console.error("Erro ao buscar operadores:", error);
        tbody.innerHTML = "<tr><td colspan='5'>Erro ao carregar dados.</td></tr>";
    }
}

async function deletarOperador(docId) {
    const senhaCorreta = "pb2025";
    const senhaDigitada = prompt("Para confirmar a exclusão, digite a senha:");

    if (senhaDigitada === null) return; 

    if (senhaDigitada === senhaCorreta) {
        if (confirm("Tem certeza que deseja deletar este operador?")) {
            try {
                await window.deleteDoc(window.doc(db, "operadores", docId));
                alert("Operador deletado com sucesso!");
                atualizarTabelaOperadores();
            } catch (error) {
                console.error("Erro ao deletar operador:", error);
                alert("Erro ao deletar. Verifique o console.");
            }
        }
    } else {
        alert("Senha incorreta. A exclusão foi cancelada.");
    }
}

async function carregarOperadores(idSetor = 'setor', idOperadorSelect = 'operadorSelect') {
    const setor = document.getElementById(idSetor).value;
    const opSelect = document.getElementById(idOperadorSelect);

    opSelect.innerHTML = '<option value="">Carregando...</option>';
    opSelect.disabled = true;

    if (!setor) {
        opSelect.innerHTML = '<option value="">Selecione o setor</option>';
        opSelect.disabled = false;
        return;
    }

    try {
        const q = window.query(operadoresCol, 
            window.where("setor", "==", setor),
            window.orderBy("nome")
        );
        const snapshot = await window.getDocs(q);
        
        opSelect.innerHTML = '<option value="">Selecione um operador</option>';
        if (snapshot.empty) {
            opSelect.innerHTML = '<option value="">Nenhum operador neste setor</option>';
        } else {
            snapshot.forEach(doc => {
                const nome = doc.data().nome;
                opSelect.add(new Option(nome, nome));
            });
        }
    } catch(error) {
        console.error("Erro ao carregar operadores:", error);
        opSelect.innerHTML = '<option value="">Erro ao carregar</option>';
    } finally {
        opSelect.disabled = false;
    }
}


document.getElementById("formProducao").addEventListener("submit", async (e)=>{
    e.preventDefault();
    if (!producoesCol || !window.addDoc) { 
        alert("Aguarde, o Firebase ainda não foi inicializado corretamente.");
        return;
    }
    const data = {
        data:document.getElementById("data").value,
        setor:document.getElementById("setor").value,
        turno:document.getElementById("turno").value,
        operador:document.getElementById("operadorSelect").value,
        maquina:document.getElementById("maquinaSelect").value, 
        massa:document.getElementById("massa").value,
        refCpb:document.getElementById("refCpb").value,
        prevista:parseFloat(document.getElementById("prevista").value),
        realizada:parseFloat(document.getElementById("realizada").value),
        quebras:parseFloat(document.getElementById("quebras").value),
        observacao:document.getElementById("observacao").value,
        timestamp: new Date().toISOString()
    };
    try {
        await window.addDoc(producoesCol, data);
        alert("Lançamento salvo com sucesso no Firebase! ✅");
        limparFormulario();
    } catch (error) {
        console.error("Erro ao adicionar documento: ", error);
        alert("Erro ao salvar o lançamento. Verifique o console. ❌"); 
    }
});

function limparFormulario(){
    document.getElementById("formProducao").reset();
    document.getElementById("operadorSelect").innerHTML = '<option value="">Selecione o setor</option>';
}

function deletarRegistro(docId) {
    const senhaCorreta = "pb2025";
    const senhaDigitada = prompt("Para confirmar a exclusão, digite a senha:");

    if (senhaDigitada === null) return;

    if (senhaDigitada === senhaCorreta) {
        if (confirm("Tem certeza que deseja deletar este registro de produção?")) {
            try {
                window.deleteDoc(window.doc(db, "producoes", docId))
                    .then(() => {
                        alert("Registro deletado com sucesso!");
                        filtrarHistorico();
                    });
            } catch (error) {
                console.error("Erro ao deletar registro: ", error);
                alert("Erro ao deletar o registro. Verifique o console.");
            }
        }
    } else {
        alert("Senha incorreta. A exclusão foi cancelada.");
    }
}

// --- LÓGICA DE EDIÇÃO DO HISTÓRICO ---
async function abrirHistoricoModal(docId) {
    try {
        const docRef = window.doc(db, "producoes", docId);
        const docSnap = await window.getDoc(docRef);

        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById('edit-id-historico').value = docId;
            document.getElementById('edit-data').value = data.data;
            document.getElementById('edit-setor').value = data.setor;
            document.getElementById('edit-turno').value = data.turno;
            document.getElementById('edit-maquina').value = data.maquina;
            document.getElementById('edit-massa').value = data.massa;
            document.getElementById('edit-refCpb').value = data.refCpb;
            document.getElementById('edit-prevista').value = data.prevista;
            document.getElementById('edit-realizada').value = data.realizada;
            document.getElementById('edit-quebras').value = data.quebras;
            document.getElementById('edit-observacao').value = data.observacao;

            await carregarOperadores('edit-setor', 'edit-operadorSelect');
            document.getElementById('edit-operadorSelect').value = data.operador;

            document.getElementById('historicoModal').style.display = 'block';
        } else {
            alert("Erro: Registro não encontrado!");
        }
    } catch (error) {
        console.error("Erro ao carregar registro para edição:", error);
    }
}

async function salvarEdicaoHistorico(e) {
    e.preventDefault();
    const docId = document.getElementById('edit-id-historico').value;
    const data = {
        data: document.getElementById("edit-data").value,
        setor: document.getElementById("edit-setor").value,
        turno: document.getElementById("edit-turno").value,
        operador: document.getElementById("edit-operadorSelect").value,
        maquina: document.getElementById("edit-maquina").value,
        massa: document.getElementById("edit-massa").value,
        refCpb: document.getElementById("edit-refCpb").value,
        prevista: parseFloat(document.getElementById("edit-prevista").value),
        realizada: parseFloat(document.getElementById("edit-realizada").value),
        quebras: parseFloat(document.getElementById("edit-quebras").value),
        observacao: document.getElementById("edit-observacao").value,
        timestamp: new Date().toISOString()
    };
    
    try {
        const docRef = window.doc(db, "producoes", docId);
        await window.updateDoc(docRef, data);
        alert("Lançamento atualizado com sucesso!");
        fecharModal();
        filtrarHistorico();
    } catch (error) {
        console.error("Erro ao salvar lançamento:", error);
        alert("Erro ao salvar. Verifique o console.");
    }
}

async function atualizarTabela(filtro, direcao = null) {
    const tbody = document.querySelector("#tabelaHistorico tbody");
    tbody.innerHTML = "<tr><td colspan='6'>Carregando dados...</td></tr>";

    if (!producoesCol) {
        tbody.innerHTML = "<tr><td colspan='6'>Erro: O Firebase não está conectado.</td></tr>";
        return;
    }

    let queryConstraints = [];
    if (filtro && filtro.dataInicio) queryConstraints.push(window.where("data", ">=", filtro.dataInicio));
    if (filtro && filtro.dataFim) queryConstraints.push(window.where("data", "<=", filtro.dataFim));
    queryConstraints.push(window.orderBy("data", "desc"), window.orderBy("timestamp", "desc"));
    
    if (direcao === 'proxima' && ultimoDocumentoVisivel) {
        queryConstraints.push(window.startAfter(ultimoDocumentoVisivel));
    } else if (direcao === 'anterior') {
        primeiroDocumentoStack.pop();
        const cursorAnterior = primeiroDocumentoStack[firstDocumentStack.length - 1];
        if(cursorAnterior) queryConstraints.push(window.startAfter(cursorAnterior));
    }
    
    queryConstraints.push(window.limit(ITENS_POR_PAGINA));
    const q = window.query(producoesCol, ...queryConstraints);

    try {
        const querySnapshot = await window.getDocs(q);
        const documentos = querySnapshot.docs;

        let filtrados = documentos.map(doc => ({ id: doc.id, ...doc.data() }));
        if (filtro) {
            filtrados = filtrados.filter(r =>
                (!filtro.setor || r.setor === filtro.setor) &&
                (!filtro.turno || r.turno === filtro.turno) &&
                (!filtro.maquina || (r.maquina && r.maquina.toLowerCase().includes(filtro.maquina.toLowerCase()))) &&
                (!filtro.refCpb || (r.refCpb && r.refCpb.toLowerCase().includes(filtro.refCpb.toLowerCase())))
            );
        }

        tbody.innerHTML = "";
        if (filtrados.length === 0) {
            tbody.innerHTML = `<tr><td colspan='6'>${paginaAtual > 1 ? 'Fim dos resultados.' : 'Nenhum registro encontrado.'}</td></tr>`;
            document.getElementById('btnProxima').disabled = true;
            return;
        }

        if(direcao === 'proxima') primeiroDocumentoStack.push(documentos[0]);
        ultimoDocumentoVisivel = documentos[documentos.length - 1];
        
        filtrados.forEach((r, index) => {
            const prev = parseFloat(r.prevista) || 0;
            const real = parseFloat(r.realizada) || 0;
            const queb = parseFloat(r.quebras) || 0;
            const percRealizadoPrevisto = prev > 0 ? ((real / prev) * 100).toFixed(2) + '%' : 'N/A';
            const totalProd = real + queb;
            const percQuebrasRealizado = totalProd > 0 ? ((queb / totalProd) * 100).toFixed(2) + '%' : 'N/A';
            
            const trPrincipal = document.createElement("tr");
            trPrincipal.innerHTML = `<td><button class="expand-btn" onclick="toggleDetalhes(${index})">+</button></td><td>${r.data}</td><td>${r.setor}</td><td>${r.maquina}</td><td>${percRealizadoPrevisto}</td><td>${percQuebrasRealizado}</td>`;
            
            const trDetalhes = document.createElement("tr");
            trDetalhes.classList.add("linha-detalhes");
            trDetalhes.id = `detalhes-${index}`;
            trDetalhes.innerHTML = `<td colspan="6"><div class="detalhe-grid"><div><span>Operador:</span> ${r.operador}</div><div><span>Turno:</span> ${r.turno}</div><div><span>Massa:</span> ${r.massa}</div><div><span>Ref/CPB:</span> ${r.refCpb || 'N/A'}</div><div><span>Prevista:</span> ${prev}</div><div><span>Realizada:</span> ${real}</div><div><span>Quebras:</span> ${queb}</div><div><span>Observação:</span> ${r.observacao || 'Nenhuma'}</div><div><span>Ação:</span> <button class="secondary" style="margin-right:5px" onclick="abrirHistoricoModal('${r.id}')">Editar</button><button class="delete-btn" onclick="deletarRegistro('${r.id}')">Deletar</button></div></div></td>`;
            
            tbody.appendChild(trPrincipal);
            tbody.appendChild(trDetalhes);
        });

        document.getElementById('infoPagina').textContent = `Página ${paginaAtual}`;
        document.getElementById('btnAnterior').disabled = (paginaAtual === 1);
        document.getElementById('btnProxima').disabled = (documentos.length < ITENS_POR_PAGINA);

    } catch (error) {
       console.error("Erro ao buscar documentos: ", error);
       tbody.innerHTML="<tr><td colspan='6'>Erro ao carregar dados. Verifique o console.</td></tr>";
    }
}

function proximaPagina() {
    paginaAtual++;
    atualizarTabela(filtroAtual, 'proxima');
}

function paginaAnterior() {
    if (paginaAtual > 1) {
        paginaAtual--;
        atualizarTabela(filtroAtual, 'anterior');
    }
}

function filtrarHistorico(){
    filtroAtual = {
        dataInicio:document.getElementById("filtroDataInicio").value,
        dataFim:document.getElementById("filtroDataFim").value,
        setor:document.getElementById("filtroSetor").value,
        turno:document.getElementById("filtroTurno").value,
        maquina:document.getElementById("filtroMaquina").value,
        refCpb:document.getElementById("filtroRefCpb").value
    };
    paginaAtual = 1;
    ultimoDocumentoVisivel = null;
    primeiroDocumentoStack = [null];
    atualizarTabela(filtroAtual);
}

function buscarTodos(){
    document.getElementById("filtroDataInicio").value = "";
    document.getElementById("filtroDataFim").value = "";
    document.getElementById("filtroSetor").value = "";
    document.getElementById("filtroTurno").value = "";
    document.getElementById("filtroMaquina").value = "";
    document.getElementById("filtroRefCpb").value = "";
    
    filtroAtual = null;
    paginaAtual = 1;
    ultimoDocumentoVisivel = null;
    primeiroDocumentoStack = [null];
    atualizarTabela(null);
}

async function exportarExcel() {
    alert("Preparando dados para exportação. Isso pode levar um momento...");
    const filtro = {
        dataInicio: document.getElementById("filtroDataInicio").value,
        dataFim: document.getElementById("filtroDataFim").value,
        setor: document.getElementById("filtroSetor").value,
        turno: document.getElementById("filtroTurno").value,
        maquina: document.getElementById("filtroMaquina").value,
        refCpb: document.getElementById("filtroRefCpb").value
    };
    const conditions = [];
    if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
    if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    const baseOrdering = [window.orderBy("data", "desc"), window.orderBy("timestamp", "desc")];
    let q = window.query(producoesCol, ...conditions, ...baseOrdering);
    try {
        const querySnapshot = await window.getDocs(q);
        const regs = [];
        querySnapshot.forEach(doc => regs.push({ id: doc.id, ...doc.data() }));
        let filtrados = regs.filter(r => 
            (!filtro.setor || r.setor === filtro.setor) &&
            (!filtro.turno || r.turno === filtro.turno) &&
            (!filtro.maquina || (r.maquina && r.maquina.toLowerCase().includes(filtro.maquina.toLowerCase()))) &&
            (!filtro.refCpb || (r.refCpb && r.refCpb.toLowerCase().includes(filtro.refCpb.toLowerCase())))
        );
        if (filtrados.length === 0) {
            alert("Nenhum dado para exportar com os filtros atuais.");
            return;
        }
        const dataToExport = filtrados.map(r => {
            const prev = parseFloat(r.prevista) || 0;
            const real = parseFloat(r.realizada) || 0;
            const queb = parseFloat(r.quebras) || 0;
            const percRealizadoPrevisto = prev > 0 ? `${((real / prev) * 100).toFixed(2)}%` : 'N/A';
            const totalProd = real + queb;
            const percQuebrasRealizado = totalProd > 0 ? `${((queb / totalProd) * 100).toFixed(2)}%` : 'N/A';
            return {
                "Data": r.data, "Setor": r.setor, "Turno": r.turno, "Operador": r.operador,
                "Máquina": r.maquina, "Massa": r.massa, "Ref/CPB": r.refCpb,
                "Prevista": prev, "Realizada": real, "Quebras": queb, "Obs": r.observacao,
                "% Realizado/Previsto": percRealizadoPrevisto, "% Quebras/Total": percQuebrasRealizado,
            };
        });
        const ws = XLSX.utils.json_to_sheet(dataToExport);
        const wb = XLSX.utils.book_new();
        XLSX.utils.book_append_sheet(wb, ws, "Histórico");
        XLSX.writeFile(wb, `Historico_Filtrado_${new Date().toISOString().split('T')[0]}.xlsx`);
    } catch(error) {
        console.error("Erro ao exportar para Excel:", error);
        alert("Ocorreu um erro ao preparar os dados para exportação.");
    }
}

function filtrarDadosDashboardLocal(dados, filtro) {
    return dados.filter(d => 
        (!filtro.setor || d.setor === filtro.setor) &&
        (!filtro.turno || d.turno === filtro.turno) &&
        (!filtro.maquina || (d.maquina && d.maquina.toLowerCase().includes(filtro.maquina.toLowerCase()))) &&
        (!filtro.refCpb || (d.refCpb && d.refCpb.toLowerCase().includes(filtro.refCpb.toLowerCase()))) &&
        (!filtro.operador || (d.operador && d.operador.toLowerCase().includes(filtro.operador.toLowerCase())))
    );
}

function calcularKPIsEstatistica(dados, prefixo) {
    let totalPrevisto = 0, totalRealizado = 0, totalQuebras = 0;
    dados.forEach(d => {
        totalPrevisto += parseFloat(d.prevista) || 0;
        totalRealizado += parseFloat(d.realizada) || 0;
        totalQuebras += parseFloat(d.quebras) || 0;
    });
    const totalProducao = totalRealizado + totalQuebras;
    const percRealPrev = totalPrevisto > 0 ? `${((totalRealizado / totalPrevisto) * 100).toFixed(2)}%` : 'N/A';
    const percQuebraTotal = totalProducao > 0 ? `${((totalQuebras / totalProducao) * 100).toFixed(2)}%` : 'N/A';
    document.getElementById(`${prefixo}Previsto`).textContent = totalPrevisto.toLocaleString();
    document.getElementById(`${prefixo}Realizado`).textContent = totalRealizado.toLocaleString();
    document.getElementById(`${prefixo}Quebras`).textContent = totalQuebras.toLocaleString();
    document.getElementById(`${prefixo}PercRealPrev`).textContent = percRealPrev;
    document.getElementById(`${prefixo}PercQuebraTotal`).textContent = percQuebraTotal;
    
    if (prefixo === 'kpiOperador') {
        const areaOperador = document.getElementById('analiseOperadorArea');
        const operadorInput = document.getElementById('dashFiltroOperador').value.trim();
        if (operadorInput && dados.length > 0) {
            document.getElementById('operadorSelecionado').textContent = operadorInput.toUpperCase(); 
            areaOperador.classList.remove('hidden');
        } else {
            document.getElementById('operadorSelecionado').textContent = "Nenhum";
            areaOperador.classList.add('hidden'); 
        }
    }
}

async function atualizarDashboard(){
    if (!producoesCol || !window.getDocs || !window.query) {
        console.error("Firebase não conectado para o Dashboard."); return;
    }
    const filtro = {
        dataInicio: document.getElementById("dashFiltroDataInicio").value,
        dataFim: document.getElementById("dashFiltroDataFim").value,
        setor: document.getElementById("dashFiltroSetor").value,
        turno: document.getElementById("dashFiltroTurno").value,
        maquina: document.getElementById("dashFiltroMaquina").value,
        refCpb: document.getElementById("dashFiltroRefCpb").value.trim(),
        operador: document.getElementById("dashFiltroOperador").value.trim()
    };
    const conditions = [];
    if(filtro.dataInicio) conditions.push(window.where("data", ">=", filtro.dataInicio));
    if(filtro.dataFim) conditions.push(window.where("data", "<=", filtro.dataFim));
    const baseOrdering = [window.orderBy("data", "desc")];
    let q = window.query(producoesCol, ...conditions, ...baseOrdering);
    try {
        const querySnapshot = await window.getDocs(q);
        const dadosGerais = [];
        querySnapshot.forEach(doc => dadosGerais.push(doc.data()));
        const dadosFiltradosGeral = filtrarDadosDashboardLocal(dadosGerais, filtro);
        calcularKPIsEstatistica(dadosFiltradosGeral, 'kpi');
        
        let dadosOperador = [];
        if (filtro.operador) {
            const filtroOperadorApenasData = { 
                dataInicio: filtro.dataInicio, dataFim: filtro.dataFim, operador: filtro.operador,
                setor: '', turno: '', maquina: '', refCpb: ''
            };
            dadosOperador = filtrarDadosDashboardLocal(dadosGerais, filtroOperadorApenasData); 
        }
        calcularKPIsEstatistica(dadosOperador, 'kpiOperador');
        
    } catch (error) {
        console.error("Erro ao carregar dados para o Dashboard: ", error);
    }
}

// TORNA AS FUNÇÕES GLOBAIS PARA SEREM ACESSADAS PELO HTML
window.deletarRegistro = deletarRegistro;
window.deletarOperador = deletarOperador;
window.filtrarHistorico = filtrarHistorico;
window.buscarTodos = buscarTodos;
window.exportarExcel = exportarExcel;
window.atualizarDashboard = atualizarDashboard;
window.limparFormulario = limparFormulario;
window.mostrarPagina = mostrarPagina;
window.toggleDetalhes = toggleDetalhes;
window.proximaPagina = proximaPagina;
window.paginaAnterior = paginaAnterior;
window.abrirHistoricoModal = abrirHistoricoModal;
window.abrirOperadorModal = abrirOperadorModal;
window.fecharModal = fecharModal;
window.atualizarTabelaOperadores = atualizarTabelaOperadores;
</script>
