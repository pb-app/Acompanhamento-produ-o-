<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Acompanhamento de Produ√ß√£o</title>

    <link rel="manifest" href="manifest.json?v=1.0.1" />
    
    <meta name="theme-color" content="#0077cc">
    
    <link rel="apple-touch-icon" href="icons/icon-180x180.png?v=1.0.1" />

    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <style>
        :root{--primary:#0077cc;--muted:#f8f9fa;--card:#ffffff;--accent:#ff9900;--danger:#dc3545;--border-color:#dee2e6;--text-dark:#212529;--text-light:#6c757d;}
        *{box-sizing:border-box}
        body{font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;margin:0;background:var(--muted);color:var(--text-dark);line-height:1.5;}
        header{background:var(--primary);color:white;padding:1rem 1.25rem;text-align:center;box-shadow:0 2px 4px rgba(0,0,0,0.1);}
        .container{max-width:1100px;margin:1.5rem auto;padding:1.5rem;background:var(--card);border-radius:12px;box-shadow:0 6px 24px rgba(0,0,0,0.08);}
        h1,h2{margin:0 0 1rem;color: var(--text-dark);}
        h2{border-bottom:2px solid var(--muted);padding-bottom:0.5rem;}
        .nav{display:flex;flex-wrap: wrap; gap:10px;justify-content:center;margin-bottom:1.5rem;border-bottom: 1px solid var(--border-color);padding-bottom: 1.5rem;}
        .nav a{color:var(--primary);text-decoration:none;font-weight:600;padding:0.5rem 1rem;border-radius:8px;transition:background-color 0.2s, color 0.2s; border: 1px solid transparent;}
        .nav a:hover{background-color:var(--muted); color: var(--text-dark);}
        .nav a.active{background-color:var(--primary);color:white;}
        form{display:grid;grid-template-columns:repeat(auto-fit, minmax(250px, 1fr));gap:1.25rem;}
        label{font-size:0.9rem;font-weight:600;margin-bottom:0.25rem;display:block;color:var(--text-light);}
        input[type="date"], input[type="text"], input[type="number"], select, textarea{width:100%;padding:0.75rem;border:1px solid var(--border-color);border-radius:8px;font-size:1rem;transition:border-color 0.2s, box-shadow 0.2s;}
        input:focus, select:focus, textarea:focus{outline:none;border-color:var(--primary);box-shadow:0 0 0 3px rgba(0, 119, 204, 0.2);}
        textarea{min-height:80px;resize:vertical;}
        .full{grid-column:1/-1}
        .form-actions{display:flex;justify-content:flex-end;gap:0.75rem;margin-top:1rem;}
        button{background:var(--primary);color:white;border:none;padding:0.75rem 1.25rem;border-radius:8px;cursor:pointer;font-weight:600;font-size:1rem;transition:background 0.2s, transform 0.1s;}
        button:hover{filter:brightness(1.1)}
        button:active{transform:scale(0.98)}
        button.secondary{background:#6c757d;color:white;}
        button.secondary:hover{background:#5a6268;}
        button.edit-btn{background:var(--accent); margin-right: 5px; padding: 0.3rem 0.6rem; font-size: 0.8rem;}
        button.delete-btn{background:var(--danger); padding: 0.3rem 0.6rem; font-size: 0.8rem;}
        .filtros{display:flex;flex-wrap:wrap;gap:1rem;align-items:center;margin-bottom:1.5rem;background-color:var(--muted);padding:1rem;border-radius:8px;}
        .filtros > * {flex: 1 1 180px;}
        table{width:100%;border-collapse:collapse;margin-top:1.5rem}
        th,td{border:1px solid var(--border-color);padding:0.75rem;text-align:center;font-size:0.9rem}
        th{background:var(--primary);color:white;font-weight:600;}
        tbody tr:nth-child(2n){background-color:var(--muted);}
        
        /* --- ESTILOS ADICIONADOS/AJUSTADOS --- */
        #pesquisaOperador {
             margin-bottom: 1.5rem;
             width: 100%;
        }
        #tabelaOperadores th, #tabelaOperadores td { text-align: left; }
        #tabelaOperadores td:last-child { text-align: center; }
        /* --- FIM DOS ESTILOS ADICIONADOS --- */

        .kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:1rem;margin-top:1.5rem;}
        .kpi-card{background:var(--muted);padding:1.25rem;border-radius:8px;box-shadow:0 2px 4px rgba(0,0,0,0.05)}
        .kpi-card h3{font-size:1rem;color:var(--text-light);margin:0 0 0.25rem}
        .kpi-card p{font-size:2rem;font-weight:bold;margin:0;color:var(--primary)}
        .kpi-card.percent p{color:#28a745}
        #analiseOperadorArea{border:2px solid var(--accent);padding:1.5rem;border-radius:10px;margin-top:1.5rem;opacity:1;transition:opacity 0.3s ease-in-out;}
        #analiseOperadorArea.hidden{opacity:0;height:0;padding:0;margin:0;border:none;overflow:hidden;}
        #analiseOperadorArea h3{color:var(--accent);text-align:center;margin-bottom:1rem;}
        #analiseOperadorArea .kpi-card p{color:var(--accent);font-size:1.8rem;}
        .linha-detalhes{display:none;background-color:#f9f9f9;}
        .linha-detalhes td{padding:1rem;text-align:left !important;border:0;}
        .linha-detalhes .detalhe-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:1rem;}
        .detalhe-grid span{font-weight:bold;color:var(--primary);}
        .expand-btn{cursor:pointer;font-weight:bold;font-size:1rem;padding:0.2rem 0.6rem;border-radius:50%;background-color:#e9ecef;border:1px solid #ced4da;}
        .expand-btn:hover{background-color:#ced4da;}
        .paginacao{display:flex;justify-content:center;align-items:center;margin-top:1.5rem;gap:1rem;}
        .modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;justify-content:center;align-items:center;z-index:1000;}
        .modal-content{background:white;padding:2rem;border-radius:12px;width:90%;max-width:800px;box-shadow:0 5px 15px rgba(0,0,0,0.3);}
        .modal-content h2{margin-top:0;}
    </style>
</head>
<body>
    <header><h1>Acompanhamento de Produ√ß√£o</h1></header>

    <div class="container">
        <div class="nav">
            <a href="#" id="linkLanc" class="active" onclick="mostrarPagina('lancamento')">Lan√ßamento</a>
            <a href="#" id="linkOper" onclick="mostrarPagina('operadores')">Operadores</a>
            <a href="#" id="linkHist" onclick="mostrarPagina('historico')">Hist√≥rico</a>
            <a href="#" id="linkDash" onclick="mostrarPagina('dashboard')">Dashboard</a>
            <a href="Massa.html" style="background-color: var(--muted); border-color: var(--border-color);">F√°brica de Massa</a>
        </div>

        <section id="lancamento">
            <!-- Seu conte√∫do de Lan√ßamento aqui -->
        </section>
        
        <section id="operadores" style="display:none;">
            <h2>Cadastro de Operadores</h2>
            <form id="formOperador">
                <div>
                    <label>Data do Cadastro</label>
                    <input type="date" id="dataCadastroOp" required />
                </div>
                <div>
                    <label>Nome do Operador</label>
                    <input type="text" id="nomeOperador" required placeholder="Nome completo" />
                </div>
                <div>
                    <label>Setor</label>
                    <select id="setorOperador" required>
                        <option value="">Selecione</option>
                        <option>Conforma√ß√£o</option>
                        <option>Esmalta√ß√£o</option>
                        <option>Embalagem</option>
                        <option>Forno Vidrado</option>
                        <option>Forno chacote</option>
                    </select>
                </div>
                <div>
                    <label>Turno</label>
                    <select id="turnoOperador" required>
                        <option value="">Selecione</option>
                        <option>Comercial</option> 
                        <option>Turno 1 (6x2)</option>
                        <option>Turno 2 (6x2)</option>
                        <option>Turno 3 (6x2)</option>
                        <option>Turno 4 (6x2)</option>
                        <option>Turno 1 (5x2)</option>
                        <option>Turno 2 (5x2)</option>
                    </select>
                </div>
                <div class="full form-actions">
                   <button type="submit">Cadastrar Operador</button>
                </div>
            </form>
            
            <h2 style="margin-top: 2rem;">Operadores Cadastrados</h2>
            <input type="text" id="pesquisaOperador" placeholder="üîé Pesquisar por nome, setor ou turno...">
             <table id="tabelaOperadores">
                <thead>
                    <tr>
                        <th>Data Cadastro</th>
                        <th>Nome</th>
                        <th>Setor</th>
                        <th>Turno</th>
                        <th>A√ß√£o</th>
                    </tr>
                </thead>
                <tbody></tbody>
            </table>
        </section>

        <section id="historico" style="display:none">
            <!-- Seu conte√∫do de Hist√≥rico aqui -->
        </section>

        <section id="dashboard" style="display:none">
            <!-- Seu conte√∫do de Dashboard aqui -->
        </section>
    </div>

    <!-- Seus Modais de Edi√ß√£o aqui -->

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-app.js";
        import { 
            getFirestore, collection, addDoc, getDocs, 
            query, where, orderBy, deleteDoc, doc, limit, startAfter,
            getDoc, updateDoc
        } from "https://www.gstatic.com/firebasejs/12.4.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB2z4mFj5qVtb59uocKK8JXhMTfi8MGSTo",
            authDomain: "acompanhamento-de-produc-b68b0.firebaseapp.com",
            projectId: "acompanhamento-de-produc-b68b0",
            storageBucket: "acompanhamento-de-produc-b68b0.firebasestorage.app",
            messagingSenderId: "891709449679",
            appId: "1:891709449679:web:43e83e076f5fb3201e1eba"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        
        window.db = db;
        window.producoesCol = collection(db, "producoes"); 
        window.operadoresCol = collection(db, "operadores");
        window.addDoc = addDoc;        
        window.getDocs = getDocs;        
        window.query = query;        
        window.where = where;        
        window.orderBy = orderBy;    
        window.deleteDoc = deleteDoc; 
        window.doc = doc;
        window.limit = limit;
        window.startAfter = startAfter;
        window.getDoc = getDoc;
        window.updateDoc = updateDoc;
        
        console.log("Firebase e Firestore inicializados!");
    </script>

<script>
// Vari√°veis globais
let todosOperadoresCadastrados = [];
let db, producoesCol, operadoresCol;

function obterDataLocalFormatada() {
    const data = new Date();
    const ano = data.getFullYear();
    const mes = String(data.getMonth() + 1).padStart(2, '0');
    const dia = String(data.getDate()).padStart(2, '0');
    return `${ano}-${mes}-${dia}`;
}

document.addEventListener("DOMContentLoaded", ()=>{
    db = window.db; 
    producoesCol = window.producoesCol; 
    operadoresCol = window.operadoresCol;
    
    const today = obterDataLocalFormatada();
    // Preenche todos os campos de data necess√°rios
    ['data', 'dataCadastroOp', 'filtroDataInicio', 'filtroDataFim', 'dashFiltroDataInicio', 'dashFiltroDataFim'].forEach(id => {
        const el = document.getElementById(id);
        if (el) el.value = today;
    });

    // Adiciona o listener CORRETO ao formul√°rio de operadores
    document.getElementById("formOperador").addEventListener("submit", cadastrarOperador);
    // Adiciona o listener para a nova barra de pesquisa
    document.getElementById("pesquisaOperador").addEventListener('keyup', renderizarTabelaFiltrada);

    // Outros listeners...
});


// ======================= FUN√á√ÉO DE CADASTRO CORRIGIDA E MELHORADA =======================
async function cadastrarOperador(e) {
    e.preventDefault(); // Impede o recarregamento da p√°gina, ESSENCIAL!
    
    const dataCadastro = document.getElementById("dataCadastroOp").value;
    const nome = document.getElementById("nomeOperador").value.trim();
    const setor = document.getElementById("setorOperador").value;
    const turno = document.getElementById("turnoOperador").value;

    if (!dataCadastro || !nome || !setor || !turno) {
        alert("Todos os campos s√£o obrigat√≥rios!");
        return;
    }

    try {
        await window.addDoc(operadoresCol, {
            dataCadastro,
            nome,
            setor,
            turno,
            timestamp: new Date().toISOString()
        });
        alert("Operador cadastrado com sucesso! ‚úÖ");
        document.getElementById("formOperador").reset();
        document.getElementById("dataCadastroOp").value = obterDataLocalFormatada();
        atualizarTabelaOperadores(); // Atualiza a lista de operadores
    } catch (error) {
        console.error("Erro ao cadastrar operador: ", error);
        alert("Erro ao cadastrar. Verifique o console. ‚ùå");
    }
}
// =======================================================================================


// ======================= NOVAS FUN√á√ïES PARA PESQUISA E RENDERIZA√á√ÉO =======================
async function atualizarTabelaOperadores() {
    const tbody = document.querySelector("#tabelaOperadores tbody");
    tbody.innerHTML = "<tr><td colspan='5'>Carregando...</td></tr>";

    if (!operadoresCol) return;

    try {
        const q = window.query(operadoresCol, window.orderBy("nome"));
        const snapshot = await window.getDocs(q);
        
        // Armazena todos os operadores na vari√°vel global para pesquisa r√°pida
        todosOperadoresCadastrados = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        renderizarTabelaFiltrada(); // Chama a fun√ß√£o para renderizar a tabela (inicialmente sem filtro)
        
    } catch (error) {
        console.error("Erro ao buscar operadores:", error);
        tbody.innerHTML = "<tr><td colspan='5'>Erro ao carregar dados.</td></tr>";
    }
}

function renderizarTabelaFiltrada() {
    const tbody = document.querySelector("#tabelaOperadores tbody");
    const termoPesquisa = document.getElementById('pesquisaOperador').value.toLowerCase();
    
    tbody.innerHTML = "";

    const operadoresFiltrados = todosOperadoresCadastrados.filter(op => {
        return op.nome.toLowerCase().includes(termoPesquisa) ||
               op.setor.toLowerCase().includes(termoPesquisa) ||
               op.turno.toLowerCase().includes(termoPesquisa);
    });

    if (operadoresFiltrados.length === 0) {
        tbody.innerHTML = "<tr><td colspan='5'>Nenhum operador encontrado.</td></tr>";
        return;
    }

    operadoresFiltrados.forEach(op => {
        const tr = document.createElement("tr");
        const dataFormatada = op.dataCadastro ? new Date(op.dataCadastro + 'T03:00:00').toLocaleDateString('pt-BR') : 'N/A';
        tr.innerHTML = `
            <td>${dataFormatada}</td>
            <td>${op.nome}</td>
            <td>${op.setor}</td>
            <td>${op.turno}</td>
            <td>
                <button class="edit-btn" onclick="abrirModalOperador('${op.id}')">Editar</button>
                <button class="delete-btn" onclick="deletarOperador('${op.id}')">Deletar</button>
            </td>`;
        tbody.appendChild(tr);
    });
}
// =========================================================================================

function mostrarPagina(pg){
    document.querySelectorAll("section").forEach(s=>s.style.display="none");
    document.getElementById(pg).style.display="block";
    document.querySelectorAll(".nav a").forEach(a=>a.classList.remove("active"));
    
    const linkId = `#link${pg.charAt(0).toUpperCase()}${pg.slice(1,4)}`;
    document.querySelector(linkId).classList.add("active");
    
    if(pg==="historico") filtrarHistorico(); 
    if(pg==="dashboard") atualizarDashboard();
    if(pg==="operadores") atualizarTabelaOperadores(); // Garante que a tabela carrega ao mudar de aba
}

async function deletarOperador(docId) {
    const senhaCorreta = "pb2025";
    const senhaDigitada = prompt("Para confirmar a exclus√£o, digite a senha:");

    if (senhaDigitada === null) return; 

    if (senhaDigitada === senhaCorreta) {
        if (confirm("Tem certeza que deseja deletar este operador?")) {
            try {
                await window.deleteDoc(window.doc(db, "operadores", docId));
                alert("Operador deletado com sucesso!");
                atualizarTabelaOperadores();
            } catch (error) {
                console.error("Erro ao deletar operador:", error);
                alert("Erro ao deletar. Verifique o console.");
            }
        }
    } else {
        alert("Senha incorreta. A exclus√£o foi cancelada.");
    }
}

// ... Cole aqui o resto do seu c√≥digo JavaScript (fun√ß√µes de hist√≥rico, dashboard, etc.) ...
// As fun√ß√µes abaixo devem ser mantidas como est√£o no seu arquivo original.

async function carregarOperadores() { /* ... seu c√≥digo original ... */ }
function limparFormulario() { /* ... seu c√≥digo original ... */ }
function deletarRegistro(docId) { /* ... seu c√≥digo original ... */ }
async function atualizarTabela(filtro, direcao = null) { /* ... seu c√≥digo original ... */ }
// E assim por diante para todas as outras fun√ß√µes.


// Exemplo de como algumas fun√ß√µes devem ser mantidas:
async function carregarOperadores() {
    const setor = document.getElementById("setor").value;
    const opSelect = document.getElementById("operadorSelect");

    opSelect.innerHTML = '<option value="">Carregando...</option>';
    opSelect.disabled = true;

    if (!setor) {
        opSelect.innerHTML = '<option value="">Selecione o setor</option>';
        opSelect.disabled = false;
        return;
    }

    try {
        const q = window.query(operadoresCol, 
            window.where("setor", "==", setor),
            window.orderBy("nome")
        );
        const snapshot = await window.getDocs(q);
        
        opSelect.innerHTML = '';
        if (snapshot.empty) {
            opSelect.innerHTML = '<option value="">Nenhum operador neste setor</option>';
        } else {
            opSelect.innerHTML = '<option value="">Selecione um operador</option>';
            snapshot.forEach(doc => {
                const nome = doc.data().nome;
                opSelect.add(new Option(nome, nome));
            });
        }
    } catch(error) {
        console.error("Erro ao carregar operadores:", error);
        opSelect.innerHTML = '<option value="">Erro ao carregar</option>';
    } finally {
        opSelect.disabled = false;
    }
}
// Cole as outras fun√ß√µes aqui...


// Adicione as fun√ß√µes ao escopo global para que os bot√µes `onclick` funcionem
window.mostrarPagina = mostrarPagina;
window.deletarOperador = deletarOperador;
// E todas as outras fun√ß√µes que s√£o chamadas pelo HTML
window.abrirModalOperador = async function(docId) { /* ... seu c√≥digo original ... */ }; // Coloque o corpo da fun√ß√£o aqui
// etc.

</script>
</body>
</html>
